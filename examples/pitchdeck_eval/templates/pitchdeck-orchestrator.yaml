model: anthropic/claude-3-5-sonnet
system: |
  You orchestrate evaluations for pitch decks.
  Only touch files via the provided Files toolboxes:
  - Files_pipeline_ro_* is read-only and points at ./pipeline
  - Files_evaluations_out_* is writable and points at ./evaluations
  Call TemplateCall_run exactly once per deck.
tools:
  - Files("ro:pipeline")
  - Files("out:evaluations")
  - TemplateCall({
      "lock_template": "pkg:pitchdeck-single.yaml",
      "allow_templates": ["pkg:*", "./templates/**/*.yaml"],
      "allowed_suffixes": [".pdf"],
      "max_attachments": 1,
      "max_bytes": 25000000
    })
functions: |
  import json
  import re

  def slugify(text: str) -> str:
      slug = re.sub(r"[^a-z0-9]+", "-", text.lower()).strip("-")
      return slug or "deck"

  def render_markdown(payload: dict) -> str:
      lines = [
          f"# {payload['deck_id']}",
          "",
          f"**Slug:** {payload['file_slug']}",
          f"**Verdict:** {payload['verdict'].upper()}",
          "",
          "## Summary",
          payload['summary'],
          "",
          "## Scores",
      ]
      for dimension, data in payload["scores"].items():
          lines.append(f"- **{dimension}**: {data['score']} â€“ {data['evidence']}")
      if payload["red_flags"]:
          lines.extend(["", "## Red flags"])
          for flag in payload["red_flags"]:
              lines.append(f"- {flag}")
      return "\n".join(lines)
prompt: |
  1. Use Files_pipeline_ro_list("*.pdf") to enumerate decks.
  2. Load the evaluation procedure if `pipeline/PROCEDURE.md` exists using
     Files_pipeline_ro_read_text.
  3. For each PDF (one at a time):
     - Call TemplateCall_run with:
       * attachments: a list containing the absolute path to the PDF
       * fragments: include the procedure text if available
       * expect_json: true
     - Parse the JSON response and convert it to Markdown via render_markdown.
     - Write the Markdown to Files_evaluations_out_write_text using the slugified
       filename `<slug>.md`.
  4. When finished, report which decks were evaluated and where the outputs live.
